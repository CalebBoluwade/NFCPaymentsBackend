# Database Migrations

This directory contains all database migration scripts for the NFC Payments Backend.

## Migration Files

1. **001_create_ledger_tables.sql** - Creates accounts and ledger_entries tables for double-entry bookkeeping
2. **002_create_users_table.sql** - Creates users table for user management
3. **003_create_cards_table.sql** - Creates cards table for NFC card management
4. **004_create_transactions_table.sql** - Creates transactions table for payment transactions
5. **005_create_audit_events_table.sql** - Creates audit_events table for HSM security logging
6. **006_create_hsm_keys_table.sql** - Creates hsm_keys table for cryptographic key management
7. **007_create_triggers.sql** - Creates triggers for automatic timestamp updates
8. **008_seed_initial_data.sql** - Seeds initial system data

## Running Migrations

### Prerequisites
- PostgreSQL client (`psql`) must be installed
- Database server must be running
- Environment variables must be set (see `.env.example`)

### Run All Migrations
```bash
cd migrations
./run_migrations.sh
```

### Environment Variables
The migration script uses these environment variables:
- `DATABASE_HOST` (default: localhost)
- `DATABASE_PORT` (default: 5432)
- `DATABASE_USER` (default: postgres)
- `DATABASE_PASSWORD` (default: password)
- `DATABASE_NAME` (default: nfc_payments)

### Migration Tracking
Migrations are tracked in the `schema_migrations` table. Each migration is run only once.

## Development

### Rollback (Development Only)
⚠️ **WARNING**: This will drop all tables and data!
```bash
cd migrations
./rollback.sh
```

### Adding New Migrations
1. Create a new SQL file with format: `XXX_description.sql`
2. Use the next sequential number (e.g., `009_add_new_feature.sql`)
3. Include proper indexes and constraints
4. Test the migration on a development database first

### Best Practices
- Always use `IF NOT EXISTS` for CREATE statements
- Include proper indexes for performance
- Use appropriate data types and constraints
- Add comments for complex logic
- Test migrations thoroughly before production

## HSM Key Management

The HSM keys are managed differently from regular database data:

1. **Key Generation**: Keys are generated by the HSM service at runtime using cryptographically secure methods
2. **Database Sync**: The `upsert_hsm_key()` function syncs HSM keys to the database for reference
3. **Automatic Sync**: Keys are automatically synced to the database when the server starts
4. **Security**: Private keys are encrypted by the HSM before storage

### Key Sync Process
- HSM generates keys in memory and on disk (encrypted)
- Server startup calls `HSMKeyService.SyncKeysToDatabase()`
- Public keys and metadata are stored in the database
- Private keys remain encrypted and managed by HSM

## Database Schema Overview

### Core Tables
- **users** - User accounts and profiles
- **cards** - NFC payment cards linked to users
- **transactions** - Payment transactions between cards
- **accounts** - Double-entry bookkeeping accounts
- **ledger_entries** - Individual ledger entries for transactions

### Security Tables
- **hsm_keys** - Cryptographic keys managed by HSM
- **audit_events** - Security audit log for all HSM operations

### Features
- Optimistic locking on accounts table
- Automatic timestamp updates via triggers
- JSONB metadata fields for extensibility
- Comprehensive indexing for performance
- Foreign key constraints for data integrity